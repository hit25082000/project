---
description: Complete guide to create APIs 
globs: ["**/apis/*.api.ts"]
alwaysApply: false
---

Complete guide to create APIs. It provides a clean interface for data access and handles all Supabase interactions.

## API Layer Rules

1. This is the **only** layer that communicates with the backend
2. Inject the `SupabaseClient` directly
3. Build all queries here, using Supabase's `select()` syntax for joins
4. Methods must return a `Promise`
5. Handle errors consistently and throw meaningful exceptions
6. Use TypeScript interfaces for request/response types
7. Implement proper error handling and logging

## Example API with patterns

```typescript
// establishment.api.ts
@Injectable({ providedIn: 'root' })
export class EstablishmentApi {
  private supabase = inject(SupabaseClient);
  
  async getList(searchTerm?: string): Promise<iEstablishmentPreview[]> {
    let query = this.supabase
      .from('establishments')
      .select('id, name, description, created_at')
      .order('created_at', { ascending: false });
    
    if (searchTerm) {
      query = query.ilike('name', `%${searchTerm}%`);
    }
    
    const { data, error } = await query;
    if (error) throw error;
    return data || [];
  }
  
  async getDetailsById(id: string): Promise<iEstablishmentDetails | null> {
    const { data, error } = await this.supabase
      .from('establishments')
      .select(`
        *,
        address:addresses (*),
        reviews:reviews (
          *,
          user:users (name, avatar_url)
        ),
        owner:users (id, name, email)
      `)
      .eq('id', id)
      .single();
    
    if (error) {
      if (error.code === 'PGRST116') return null; // Not found
      throw error;
    }
    return data;
  }
  
  async create(establishment: iEstablishmentCreate): Promise<iEstablishment> {
    const { data, error } = await this.supabase
      .from('establishments')
      .insert(establishment)
      .select()
      .single();
    
    if (error) throw error;
    return data;
  }
  
  async update(id: string, establishment: iEstablishmentUpdate): Promise<iEstablishment> {
    const { data, error } = await this.supabase
      .from('establishments')
      .update(establishment)
      .eq('id', id)
      .select()
      .single();
    
    if (error) throw error;
    return data;
  }
  
  async delete(id: string): Promise<void> {
    const { error } = await this.supabase
      .from('establishments')
      .delete()
      .eq('id', id);
    
    if (error) throw error;
  }
}
```
### Error Handling for api
- **Error Handling**: See `error_handling_patterns.md#API Layer Error Handling` 

### Reference Documentation (READ ONLY IF NEEDED)
- **Detailed Testing Examples**: See `api_testing_reference.md`
- **Naming Convention Examples**: See `api_naming_reference.md`
- **Helper Functions**: See `api_testing_reference.md#helper-functions`
- **Advanced Patterns**: See `api_testing_reference.md#advanced-patterns`
